DATA PROVENANCE FRAMEWORK v5.5

================================================================================
VERSION INFORMATION
================================================================================

VERSION: 5.5
DATE: January 2026
STATUS: Production Ready
COMPLIANCE: 6-Rule Compliant
PURPOSE: Data source categories, trust hierarchy, and conflict resolution
COMPLIANCE: 6-Rule Compliance Framework

================================================================================
OVERVIEW
================================================================================

The Media Planning Agent operates with data from multiple sources. This framework defines the four provenance categories, trust hierarchy, conflict resolution rules, and session isolation requirements.

v5.0 ADDITIONS:
- Web Research as explicit Category 3 source
- Confidence Level impact by data source
- Error handling when sources conflict
- Enhanced conflict resolution rules
- Research integration patterns

================================================================================
SECTION 1: DATA PROVENANCE CATEGORIES
================================================================================

CATEGORY 1: USER PROVIDED

Source: Information provided by user during current session
Trust Level: HIGHEST (for current session)
Confidence Impact: INCREASES confidence when consistent with benchmarks

Characteristics:
- Overrides all other data sources for current session
- Applies only to current session
- Stored in Dataverse SessionCustomizations table
- Not propagated to other users or sessions

Examples:
- Client-specific targets ("Our CAC target is $65")
- Actual performance data ("We are seeing $22 CPMs on Meta")
- Budget constraints ("Total budget is $500K")
- Channel exclusions ("We cannot use TikTok")
- Historical client data from uploaded files
- Verified platform data shared by user

Agent Behavior:
- Accept and acknowledge user-provided values immediately
- Use user values instead of all other sources for session
- Create SessionCustomization record in Dataverse
- Remind user these are session-specific if relevant
- Note when user data differs significantly from benchmarks

Confidence Level Effect:
- User data WITH historical backup: HIGH confidence
- User data WITHOUT historical backup: MEDIUM-HIGH confidence
- User data contradicting benchmarks: Flag but use, MEDIUM confidence

--------------------------------------------------------------------------------

CATEGORY 2: INTERNAL AGENT KNOWLEDGE BASE

Source: SharePoint-hosted knowledge base documents and registry files
Trust Level: HIGH
Confidence Impact: Baseline confidence level for projections

Characteristics:
- Pre-validated research and benchmarks
- Updated quarterly by administrators
- Version-controlled and auditable
- Available to all users
- Stable and reliable

Examples:
- KPI definitions and benchmarks (mpa_kpi table (Dataverse))
- Channel CPM/CPC ranges (mpa_channel table (Dataverse))
- Vertical budget benchmarks (mpa_vertical and mpa_benchmark tables (Dataverse))
- DSP/SSP fee benchmarks (mpa_partner table (Dataverse))
- Research documents (Budget_Allocation_Research_v1.docx)

Agent Behavior:
- Use as default values when user provides no override
- Cite as source when presenting benchmarks
- Never modify during conversations
- Cross-reference with web research when available

Confidence Level Effect:
- KB data alone: Baseline confidence per KPI type
- KB data validated by web research: INCREASE confidence
- KB data contradicted by web research: Note discrepancy, maintain KB default

--------------------------------------------------------------------------------

CATEGORY 3: PUBLIC INTERNET (WEB RESEARCH)

Source: Web search results and publicly available data
Trust Level: MEDIUM
Confidence Impact: Supplementary - can increase or flag concerns

Characteristics:
- Real-time but unvalidated
- May conflict with KB benchmarks
- Requires cross-reference validation
- Use for current events, news, recent changes
- Subject to search quality variation

Examples:
- Recent platform fee changes
- New channel launches or closures
- Industry news affecting recommendations
- Competitive intelligence from ad libraries
- Current market conditions
- Regional CPM variations

Agent Behavior:
- Use for supplementary information
- Cross-reference with multiple sources when possible
- Note uncertainty when data conflicts with KB
- Never use public data to override KB benchmarks without user confirmation
- Always cite source when presenting web findings
- Apply session isolation (do not modify KB)

Confidence Level Effect:
- Web data confirms KB: INCREASE confidence
- Web data supplements KB: No change to confidence
- Web data contradicts KB: FLAG discrepancy, maintain KB confidence
- Web data only (no KB reference): LOW confidence, treat as estimate

Research Integration Rules:
- Search when: Vertical mentioned, geography specified, competitor named
- Present findings: Cite source, note recency
- Resolve conflicts: KB default unless user confirms web data
- Session scope: Web findings apply to session only

--------------------------------------------------------------------------------

CATEGORY 4: DIRECT API

Source: Authenticated platform APIs (future capability)
Trust Level: HIGH
Confidence Impact: INCREASES confidence significantly for platform-specific metrics

Characteristics:
- Real-time, authoritative for specific platform
- Requires OAuth authentication
- Client-specific actual data
- Stored in CampaignPerformance tables

Examples:
- Actual spend from DV360 API
- Conversion data from Google Ads API
- Meta Ads performance metrics
- Platform-reported CPMs and fees

Agent Behavior:
- Use as ground truth for platform-specific metrics
- Reconcile with user-provided data
- Flag discrepancies between API and user data
- Store in Dataverse for historical analysis

Confidence Level Effect:
- API data available: HIGH confidence for that metric
- API data with historical pattern: VERY HIGH confidence
- API data conflicting with user data: Flag, ask for reconciliation

================================================================================
SECTION 2: TRUST HIERARCHY
================================================================================

2.1 PRIORITY ORDER FOR CONFLICTING DATA

Priority 1 (HIGHEST): USER PROVIDED
- Always wins for current session calculations
- User intent governs even if data seems incorrect
- Agent may flag concerns but must use user value

Priority 2: DIRECT API
- Use when available and user has not overridden
- Real-time platform truth

Priority 3: INTERNAL AGENT KB
- Default when no user or API data
- Stable, validated benchmarks

Priority 4 (LOWEST): PUBLIC INTERNET
- Supplementary only
- Never overrides higher sources without explicit user confirmation

--------------------------------------------------------------------------------

2.2 CONFLICT RESOLUTION RULES

SCENARIO: User data vs KB benchmark
- Resolution: Use user data
- Agent response: "Using your provided CAC target of $65 instead of the benchmark range of $50-150."

SCENARIO: API reports different than user says
- Resolution: Flag discrepancy, ask user
- Agent response: "I notice your platform shows $18 CPM, but you mentioned $22. Which should I use for planning?"

SCENARIO: Web research contradicts KB
- Resolution: Note discrepancy, use KB, offer user choice
- Agent response: "Our benchmarks show X, but recent industry data suggests Y has changed. Shall I use the updated figure?"

SCENARIO: Multiple user inputs conflict
- Resolution: Ask for clarification
- Agent response: "Earlier you mentioned $150K budget, but now $175K. Which is the correct figure?"

SCENARIO: KB missing data for request
- Resolution: Use web research, note confidence reduction
- Agent response: "I do not have benchmark data for this niche vertical. Based on related industries and web research, I estimate X with MEDIUM-LOW confidence."

--------------------------------------------------------------------------------

2.3 CONFIDENCE LEVEL BY DATA SOURCE COMBINATION

Source Combination                          Confidence Effect
------------------------------------------ ---------------------------
User + API + KB aligned                     HIGH (maximum)
User + KB aligned                           MEDIUM-HIGH
KB alone                                    Baseline (per KPI type)
KB + Web research aligned                   Baseline + slight increase
User contradicts KB (user governs)          MEDIUM (flag)
Web research alone (no KB)                  LOW
Multiple sources conflict                   MEDIUM-LOW (flag all)

================================================================================
SECTION 3: SESSION ISOLATION
================================================================================

3.1 PRINCIPLE

User customizations MUST NOT affect other users or future sessions.

--------------------------------------------------------------------------------

3.2 IMPLEMENTATION ARCHITECTURE

SHARED KNOWLEDGE BASE (Read-Only):
- SharePoint Files
- Registry Files
- Research Documents
- Reference Data
- NEVER modified by agent during conversations

AGENT RUNTIME:
- Load KB defaults
- Load session customizations from Dataverse
- Load web research findings (session-scoped)
- Apply user overrides for calculations
- Generate outputs

SESSION DATA (Dataverse - Write):
- SessionCustomizations Table
- Session-specific overrides
- Isolated per session, per user

--------------------------------------------------------------------------------

3.3 SESSION CUSTOMIZATIONS TABLE

SCHEMA:
- customization_id (PK, GUID)
- session_id (FK to Sessions)
- plan_id (FK to MediaPlans, nullable)
- user_id (FK to Users)
- source_category (enum: KPI, Channel, Partner, Benchmark, WebResearch, Other)
- source_registry (string) - which registry file affected
- source_item_id (string) - registry entry ID
- original_value (string) - KB default value
- custom_value (string) - user-provided or web-sourced value
- data_provenance (enum: USER, API, WEB, KB)
- customization_reason (text, nullable)
- applied_at (datetime)
- expires_at (datetime, nullable)
- is_active (boolean)

--------------------------------------------------------------------------------

3.4 SESSION LIFECYCLE

PHASE 1 - SESSION START:
- Agent loads KB defaults
- Agent loads any prior customizations for this session
- No cross-session contamination
- Web research cache cleared

PHASE 2 - DURING SESSION:
- User provides custom values
- Agent conducts web research
- Agent creates SessionCustomization records
- Agent uses custom values for all calculations
- All sources tracked with provenance

PHASE 3 - SESSION END:
- Customizations remain in Dataverse
- Associated with plan if plan was created
- Available if user returns to same plan
- Web research findings NOT persisted

PHASE 4 - NEW SESSION (Same User, Same Plan):
- Agent loads prior customizations for that plan
- User can modify or reset to KB defaults
- Fresh web research may be triggered

PHASE 5 - NEW SESSION (Different User or Plan):
- Starts fresh with KB defaults
- No access to other users customizations
- Complete session isolation maintained

================================================================================
SECTION 4: WEB RESEARCH INTEGRATION (v5.0 NEW)
================================================================================

4.1 RESEARCH TRIGGER POINTS

AUTOMATIC TRIGGERS:
- Vertical mentioned: Search for vertical benchmarks
- Geography specified: Search for regional cost data
- Competitor named: Search ad libraries for competitive intel
- Platform mentioned: Search for recent changes
- Unusual request: Search for niche data

RESEARCH PROCESS:
- Identify information gap
- Formulate search query
- Execute search
- Evaluate result quality
- Compare to KB
- Present findings with source
- Apply session isolation

--------------------------------------------------------------------------------

4.2 RESEARCH QUALITY ASSESSMENT

HIGH QUALITY SOURCES (prioritize):
- Platform official documentation
- Industry association reports (IAB, ANA)
- Major research firms (eMarketer, Gartner, Nielsen)
- Company investor relations
- Government statistics

MEDIUM QUALITY SOURCES (use with caution):
- Industry news publications
- Marketing blogs from known experts
- Case studies with verifiable data
- Conference presentations

LOW QUALITY SOURCES (avoid or flag):
- Generic marketing blogs
- Outdated content (over 18 months)
- Sources without methodology
- Aggregator sites without original research

--------------------------------------------------------------------------------

4.3 RESEARCH PRESENTATION FORMAT

When presenting web research findings:

SAMPLE OUTPUT:
"Based on recent industry data from [source name] ([date]):
- Finding 1: [specific data point]
- Finding 2: [specific data point]

This [confirms/differs from] our benchmark of [KB value].

Confidence: [LEVEL] because [reason].

Would you like me to use [KB value] or [web value] for this plan?"

================================================================================
SECTION 5: DATA CITATION REQUIREMENTS (MANDATORY)
================================================================================

5.1 THE FIVE REQUIRED SOURCE TYPES

Every data claim MUST cite exactly one of these five sources:

1. KNOWLEDGE BASE
   Data from KB documents (benchmarks, frameworks, guidance)
   Format: "Based on Knowledge Base, [claim]."
   Example: "Based on Knowledge Base, streetwear CAC typically runs $25-50."
   No link required.

2. WEBSEARCH
   Fresh data from a newly triggered web search or scrape
   Format: "Based on Websearch, [claim] [source: URL]."
   Example: "Based on Websearch, Meta CPMs increased 12% in Q4 [source: emarketer.com/cpm-report-2026]."
   MUST include link to source.

3. API CALL
   Data pulled from a direct API call (platform data, real-time metrics)
   Format: "Based on API Call, [claim]."
   Example: "Based on API Call, your current Meta CPM is $8.50."
   No link required.

4. USER PROVIDED
   Data the user gave during the conversation
   Format: "Based on User Provided, [claim]."
   Example: "Based on User Provided, your budget is $1.5M."
   No link required.

5. BENCHMARK
   Broad industry or market data from stale or general websearch results
   Format: "Based on Benchmark, [claim] [source: URL]."
   Example: "Based on Benchmark, fashion ecommerce CAC ranges $20-80 [source: wordstream.com/benchmark-report]."
   MUST include link to source.

--------------------------------------------------------------------------------

5.2 CITATION RULES

RULE 1: Every data claim requires a source
- Any number, percentage, range, or benchmark MUST have a citation
- Calculations derived from cited data inherit the source

RULE 2: Websearch and Benchmark require links
- These are external sources that need verification
- Link format: [source: domain.com/path]

RULE 3: Use the exact phrasing
- Start with "Based on [Source Type]"
- This ensures consistent scoring and user trust

--------------------------------------------------------------------------------

5.3 WRONG VS RIGHT EXAMPLES

WRONG: "For streetwear, CAC runs $25-50."
RIGHT: "Based on Knowledge Base, streetwear CAC typically runs $25-50."

WRONG: "CPMs have been rising lately."
RIGHT: "Based on Websearch, CPMs rose 15% YoY [source: marketingweek.com/cpm-trends-2026]."

WRONG: "Your efficiency looks achievable."
RIGHT: "Based on Knowledge Base, $50 per customer is achievable - home goods benchmarks run $40-70."

WRONG: "Industry data shows X."
RIGHT: "Based on Benchmark, industry data shows X [source: emarketer.com/report]."

--------------------------------------------------------------------------------

5.4 WHEN CITATION IS NOT REQUIRED

Citation is NOT required for:
- Calculation results (the inputs should be cited, not the math)
- General strategic recommendations without specific numbers
- Process explanations or methodology descriptions
- Questions to the user

================================================================================
SECTION 6: ERROR HANDLING FOR DATA CONFLICTS (v5.0 NEW)
================================================================================

6.1 CONFLICT DETECTION

Agent MUST detect and flag:
- User data outside KB benchmark range
- Web research contradicting KB
- Multiple user inputs that conflict
- API data mismatched with user claims
- Calculations producing impossible results

--------------------------------------------------------------------------------

6.2 CONFLICT RESOLUTION FLOW

CONFLICT DETECTED
    |
    +-- User data vs KB?
    |   +-- Action: Flag the difference
    |   +-- Action: Use user data (priority)
    |   +-- Action: Note confidence impact
    |   +-- Response: "Your target of X is [above/below] the benchmark range of Y-Z. I will use your target. Note this may impact projection accuracy."
    |
    +-- Web vs KB?
    |   +-- Action: Present both values
    |   +-- Action: Default to KB
    |   +-- Action: Offer user choice
    |   +-- Response: "Our benchmarks show X, but recent data suggests Y. Which would you prefer to use?"
    |
    +-- User vs User (prior input)?
    |   +-- Action: Ask for clarification
    |   +-- Action: Do not proceed until resolved
    |   +-- Response: "Earlier you mentioned X, but now Y. Could you clarify which is correct?"
    |
    +-- Impossible calculation result?
        +-- Action: Identify likely cause
        +-- Action: Suggest verification
        +-- Response: "This calculation produced an unusual result. Let me verify the inputs with you..."

--------------------------------------------------------------------------------

6.3 GRACEFUL DEGRADATION

When data is missing or unreliable:

MISSING KB DATA:
- Use web research with citation
- Note reduced confidence
- Recommend verification

MISSING USER DATA:
- Use KB default
- Note assumption made
- Request confirmation

CONFLICTING ALL SOURCES:
- Present all values
- Explain discrepancy
- Ask user to decide
- Document decision rationale

================================================================================
SECTION 7: DATA VALIDATION RULES
================================================================================

7.1 INPUT VALIDATION

Data Type           Validation Rule              Agent Response if Invalid
------------------ ---------------------------- ----------------------------
Budget              Must be positive number      "Please provide a valid budget amount"
Percentage          Must be 0-100               "Percentages should be between 0 and 100"
CPM                 Must be positive, 1-100     Warn if outside typical range
CAC                 Must be positive            Accept any positive, warn if extreme
Date                Must be valid format        Ask for clarification
Duration            Must be positive days       "Campaign duration must be at least 1 day"

--------------------------------------------------------------------------------

7.2 REASONABLENESS CHECKS

Agent MUST flag values that seem unreasonable:
- CPM over $100 or under $1
- CAC over $1,000 (for non-enterprise B2B)
- ROAS under 1.0 (losing money)
- Budget under channel minimums
- Fee percentages over 50%
- Conversion rates over 20%
- CTR over 10%

Agent response pattern:
"That [metric] of [value] seems unusual. Most campaigns see [typical range]. Would you like to proceed with this value or verify it?"

================================================================================
SECTION 8: AUDIT AND COMPLIANCE
================================================================================

8.1 DATA LINEAGE TRACKING

Every calculation includes provenance metadata:

SAMPLE LINEAGE RECORD:
- calculation: "Projected CAC"
- result: 72.50
- inputs:
  - field: "budget"
    value: 150000
    source: "USER_PROVIDED"
    timestamp: "2025-12-22T10:30:00Z"
  - field: "target_conversions"
    value: 2000
    source: "USER_PROVIDED"
    timestamp: "2025-12-22T10:31:00Z"
  - field: "fee_adjustment"
    value: 0.97
    source: "INTERNAL_KB"
    registry: "mpa_partner table (Dataverse)"
  - field: "regional_cpm_adjustment"
    value: 1.15
    source: "WEB_RESEARCH"
    search_date: "2025-12-22"
    source_url: "emarketer.com/regional-cpm-report"

--------------------------------------------------------------------------------

8.2 COMPLIANCE REQUIREMENTS

GDPR/CCPA:
- No PII stored in knowledge base
- User data isolated by session
- Deletion requests honored

Data Retention:
- Session data retained per client policy
- Web research not persisted
- KB updates tracked with version history

Audit Trail:
- All customizations logged with timestamp and user
- Data provenance recorded for all calculations
- Conflict resolutions documented

Access Control:
- Users can only see their own session data
- KB is read-only to all users
- Admin access required for KB updates

================================================================================
SUMMARY
================================================================================

Category            Trust    Persistence    Modifiable    Confidence Impact
------------------ -------- -------------- ------------- --------------------
User Provided       HIGHEST  Session        Record only   INCREASES (verified)
Direct API          HIGH     Permanent      NO            INCREASES
Internal KB         HIGH     Permanent      NO            BASELINE
Public Internet     MEDIUM   None           NO            SUPPLEMENTARY

KEY PRINCIPLES:
- User data wins for current session
- KB provides stable defaults
- Web research supplements but never overrides without permission
- Session isolation protects all users
- Everything is auditable with provenance
- Confidence levels reflect data source quality

================================================================================
VERSION HISTORY
================================================================================

VERSION 5.0 (January 2026):
- Added Web Research as explicit Category 3 source
- Added Confidence Level impact documentation
- Added Error Handling for Data Conflicts section
- Added Research Quality Assessment criteria
- Added Research Presentation Format
- Enhanced conflict resolution rules
- Added graceful degradation patterns
- Updated trust hierarchy with confidence effects

VERSION 1.0 (Initial):
- Four provenance categories defined
- Trust hierarchy established
- Session isolation documented
- Basic conflict resolution

================================================================================
END OF DATA PROVENANCE FRAMEWORK v5.0
================================================================================
