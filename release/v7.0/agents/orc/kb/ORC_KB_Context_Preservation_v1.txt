DOCUMENT: ORC_KB_Context_Preservation_v1.txt
CATEGORY: Orchestrator Knowledge Base
TOPICS: session state, context, memory, handoffs, continuity
VERSION: 1.0
DATE: January 2026
STATUS: Production Ready
COMPLIANCE: 6-Rule Compliant
RELATED: ORC_KB_Workflow_Gates_v1, ORC_KB_Error_Handling_v1

ORC CONTEXT PRESERVATION v1

PURPOSE

This document provides guidance on maintaining session context across agent interactions. Reference when managing multi-turn conversations, agent handoffs, or session state persistence.

CONTEXT FUNDAMENTALS

WHAT CONTEXT TO PRESERVE

User Inputs:
- Campaign brief and requirements
- Business objectives stated
- Constraints and preferences
- Questions asked
- Clarifications provided
- Approvals given

Agent Outputs:
- Calculations performed
- Recommendations made
- Data retrieved
- Analysis results
- Documents generated
- Warnings issued

Decisions Made:
- Choices selected by user
- Options rejected
- Trade-offs accepted
- Modifications requested
- Approvals recorded

Progress Markers:
- Workflow steps completed
- Gates passed
- Current position in process
- Pending actions
- Next steps identified

CONTEXT LIFECYCLE

Creation:
Context begins when session initializes. Core fields populated from user first message and any provided background data.

Updates:
Context updated after each agent interaction. New information merged with existing context. Conflicting information resolved with recency preference.

Persistence:
Context persisted to Dataverse after each significant update. Enables session recovery and audit trail.

Expiration:
Sessions expire after 24 hours of inactivity. Extended sessions may persist up to 7 days with explicit user action.

SESSION STATE STRUCTURE

CORE SESSION FIELDS

Campaign Brief:
- Campaign name and identifier
- Business objective
- Success metrics
- Campaign duration
- Special requirements

Budget Parameters:
- Total budget amount
- Currency
- Budget flexibility
- Minimum spend thresholds
- Allocation constraints

Timeline:
- Campaign start date
- Campaign end date
- Key milestones
- Approval deadlines
- Review checkpoints

Audience Definition:
- Target audience description
- Segment priorities
- Exclusions specified
- Geographic scope
- Demographic parameters

PROGRESS TRACKING

Workflow Position:
- Current workflow step (1-10)
- Steps completed list
- Steps pending list
- Current gate position

Gate Status:
- Gate 1: Objectives confirmed (Y/N)
- Gate 2: Audience approved (Y/N)
- Gate 3: Channels selected (Y/N)
- Gate 4: Budget allocated (Y/N)
- Gate 5: Plan approved (Y/N)

Completion Estimates:
- Estimated remaining steps
- Estimated completion time
- Blocker indicators
- Risk flags

AGENT INTERACTION HISTORY

Specialist Consultations:
- Agents consulted list
- Last consulted timestamp
- Key outputs from each
- Pending follow-ups

Example Structure:
- ANL: Projection calculated, 500K impressions, HIGH confidence
- AUD: Segments identified, 3 priority, MEDIUM confidence
- CHA: Allocation recommended, 4 channels, HIGH confidence

Handoff Context:
- Originating agent
- Target agent
- Reason for handoff
- Data passed
- Expected return

CONTEXT ACROSS HANDOFFS

SPECIALIST AGENT HANDOFFS

What Context to Pass to Specialists:

Always Include:
- Campaign brief summary
- Current workflow position
- User objective for this interaction
- Relevant prior agent outputs
- Constraints and requirements

Selective Include:
- Full calculation history if needed
- Complete segment details if relevant
- Budget breakdown if applicable
- Timeline specifics if time-sensitive

Never Include:
- Unrelated prior conversations
- Redundant historical data
- Personal user information
- System debugging data

What Context to Expect Back:

Required Returns:
- Primary output or result
- Confidence level
- Key assumptions made
- Data sources used
- Recommended next steps

Optional Returns:
- Alternative options considered
- Warnings or caveats
- Cross-agent dependencies
- Suggested follow-up questions

CONTEXT COMPRESSION

When passing context to specialists or preserving long sessions, compression may be necessary.

Summarization Approach:
- Convert detailed outputs to key findings
- Preserve numbers and decisions
- Remove intermediate calculations
- Maintain action items
- Keep warnings and flags

Priority Preservation:
- User stated requirements: highest priority
- Decision points and choices: high priority
- Calculation results: medium priority
- Process details: low priority, can be regenerated

Token Efficiency:
- Limit history to last 5 relevant interactions
- Summarize older context
- Reference stored data by ID when possible
- Avoid repeating static information

RETURN CONTEXT HANDLING

When specialist agent returns, orchestrator must integrate output.

Integration Steps:
1. Validate response format
2. Extract key outputs
3. Update session state
4. Check for conflicts with existing context
5. Resolve conflicts if present
6. Update progress markers
7. Determine next action

Conflict Resolution:
When new data conflicts with existing context:
- Newer data takes precedence for facts
- User preferences always respected
- Explicit user choices never overridden
- Flag conflicts for user resolution if material

MULTI-TURN CONTINUITY

CONVERSATION THREADING

Maintaining Coherent Dialogue:
Users expect continuity across messages. The agent should remember what was discussed and build on prior context.

Threading Principles:
- Reference prior topics when relevant
- Build on established facts
- Avoid asking questions already answered
- Acknowledge changes when user updates input

Reference Resolution:
When user says "that budget" or "the first option":
- Identify referent from context
- Confirm understanding if ambiguous
- Use explicit values in responses
- Avoid pronoun ambiguity in agent responses

USER INTENT TRACKING

Understanding Evolving Needs:
User intent may shift during conversation. Track both explicit and implicit intent signals.

Intent Categories:
- Planning: Building the media plan
- Clarifying: Seeking to understand
- Modifying: Changing prior decisions
- Validating: Confirming understanding
- Executing: Ready to proceed

Intent Shift Signals:
- New questions in different area
- Backtracking to prior steps
- Expressing uncertainty about decisions
- Requesting alternatives
- Time pressure mentions

CLARIFICATION HANDLING

When Context is Ambiguous:
Sometimes available context is insufficient. Clarification needed.

Effective Clarification Questions:
- Specific, not open-ended
- Reference what is known
- Offer options when appropriate
- Explain why clarification needed
- Minimize clarification rounds

Clarification Examples:
- Good: You mentioned $500K budget. Is that total or per channel?
- Poor: What is the budget?
- Good: Should we prioritize reach (more people, fewer times) or frequency (fewer people, more times)?
- Poor: What do you want to prioritize?

ERROR RECOVERY CONTEXT

PRESERVING STATE ON ERRORS

When Errors Occur:
Save context before error handling to enable recovery.

What to Save:
- Last known good state
- User inputs since last save
- Partial results if any
- Error details
- Recovery options

Recovery Point Creation:
Create explicit recovery points at:
- Gate passage
- Significant user decisions
- Major calculation completion
- Document generation
- Approval milestones

ROLLBACK CAPABILITIES

When to Restore Previous State:
- User requests to undo
- Error corrupted current state
- User wants to explore different path
- System failure recovery needed

Rollback Procedure:
1. Confirm user intent to rollback
2. Identify target recovery point
3. Restore context to that point
4. Notify user of restored state
5. Continue from recovery point

User Confirmation Requirements:
Never rollback without user confirmation unless:
- Current state is unrecoverable
- Error makes continuation impossible
- User explicitly pre-authorized

CONTEXT STORAGE

SESSION PERSISTENCE

Dataverse Integration:
Sessions stored in eap_session table with:
- session_id: Unique identifier
- user_id: User reference
- context_json: Serialized context
- created_at: Session start
- updated_at: Last modification
- status: Active, completed, expired

Persistence Triggers:
- Gate passage
- Agent handoff completion
- User explicit save
- Significant decision made
- Every 5 minutes during active conversation

SESSION TIMEOUT HANDLING

Inactivity Timeout:
- Warning at 20 minutes idle
- Session paused at 30 minutes
- Full timeout at 24 hours

Resume Capability:
- Sessions can resume within timeout window
- Context restored on resume
- User notified of time gap
- Confirm if context still valid

Extended Sessions:
- User can request extended persistence
- Up to 7 days with explicit request
- Requires periodic confirmation
- Storage costs may apply

PRIVACY CONSIDERATIONS

What Not to Persist:
- Sensitive personal information
- Payment details
- Authentication credentials
- Competitor intelligence
- Confidential business data

User Data Handling:
- Comply with data retention policies
- Honor deletion requests
- Encrypt stored context
- Limit access to authorized systems
- Audit access logs

CROSS-REFERENCES

For workflow gates: See ORC_KB_Workflow_Gates_v1
For error handling: See ORC_KB_Error_Handling_v1

VERSION HISTORY

Version 1.0 - January 2026 - Initial creation covering context fundamentals, session state, handoffs, continuity, error recovery, and storage
