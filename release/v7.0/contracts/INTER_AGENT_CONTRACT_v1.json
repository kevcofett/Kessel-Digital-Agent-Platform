{
  "$schema": "https://json-schema.org/draft/2020-12/schema",
  "$id": "https://kessel-digital.com/schemas/inter-agent-contract-v1.json",
  "title": "Multi-Agent Communication Contract v1",
  "description": "Defines the communication protocol and data structures for inter-agent communication in the MPA multi-agent architecture.",
  "version": "1.0.0",
  "definitions": {
    "AgentCode": {
      "type": "string",
      "enum": ["ORC", "ANL", "AUD", "CHA", "SPO", "DOC", "PRF", "CHG", "CST", "MKT", "GHA", "DOCS", "MMM", "MMO", "TAL", "DYN", "RMN", "SES", "MEI", "SAL", "DTA"],
      "description": "3-letter code identifying an agent"
    },
    "ConfidenceLevel": {
      "type": "string",
      "enum": ["HIGH", "MEDIUM", "LOW"],
      "description": "Confidence level for agent responses"
    },
    "DataSource": {
      "type": "string",
      "enum": [
        "USER_PROVIDED",
        "AGENT_KB",
        "DATAVERSE",
        "CALCULATION",
        "WEB_RESEARCH",
        "HISTORICAL_DATA",
        "BENCHMARK_DATA",
        "THIRD_PARTY_API",
        "DATABRICKS_DELTA",
        "DATABRICKS_ANALYTICS"
      ],
      "description": "Source of data used in the response"
    },
    "SessionType": {
      "type": "string",
      "enum": ["Planning", "InFlight", "PostMortem", "Audit"],
      "description": "Type of media planning session"
    },
    "RequestOptions": {
      "type": "object",
      "properties": {
        "timeout_ms": {
          "type": "integer",
          "minimum": 1000,
          "maximum": 300000,
          "description": "Request timeout in milliseconds"
        },
        "include_sources": {
          "type": "boolean",
          "description": "Include source attribution in response"
        },
        "confidence_threshold": {
          "$ref": "#/definitions/ConfidenceLevel",
          "description": "Minimum confidence level required"
        },
        "max_retries": {
          "type": "integer",
          "minimum": 0,
          "maximum": 5,
          "description": "Maximum retry attempts on failure"
        },
        "fallback_to_orc": {
          "type": "boolean",
          "description": "Fall back to ORC if specialist fails"
        }
      },
      "additionalProperties": false
    },
    "PlanState": {
      "type": "object",
      "properties": {
        "client_context": {
          "type": "object",
          "properties": {
            "client_name": { "type": "string" },
            "industry": { "type": "string" },
            "vertical": { "type": "string" },
            "market_position": {
              "type": "string",
              "enum": ["leader", "challenger", "niche", "emerging"]
            },
            "compliance_needs": {
              "type": "array",
              "items": { "type": "string" }
            },
            "geographic_focus": {
              "type": "array",
              "items": { "type": "string" }
            }
          },
          "required": ["industry", "vertical"]
        },
        "objectives": {
          "type": "object",
          "properties": {
            "primary_kpi": { "type": "string" },
            "target_value": { "type": "number" },
            "target_unit": { "type": "string" },
            "secondary_kpis": {
              "type": "array",
              "items": { "type": "string" }
            },
            "campaign_type": {
              "type": "string",
              "enum": ["awareness", "consideration", "conversion", "retention"]
            },
            "timeline": {
              "type": "object",
              "properties": {
                "start_date": { "type": "string", "format": "date" },
                "end_date": { "type": "string", "format": "date" },
                "duration_weeks": { "type": "integer" }
              }
            }
          },
          "required": ["primary_kpi"]
        },
        "budget": {
          "type": "object",
          "properties": {
            "total_budget": { "type": "number", "minimum": 0 },
            "currency": { "type": "string", "minLength": 3, "maxLength": 3 },
            "pacing": {
              "type": "string",
              "enum": ["even", "front_loaded", "back_loaded", "custom"]
            },
            "working_media_percentage": {
              "type": "number",
              "minimum": 0,
              "maximum": 100
            }
          },
          "required": ["total_budget", "currency"]
        },
        "audience": { "type": "object" },
        "channels": { "type": "object" },
        "partners": { "type": "object" },
        "measurement": { "type": "object" },
        "optimization": { "type": "object" },
        "compliance": { "type": "object" },
        "document": { "type": "object" }
      },
      "additionalProperties": false
    },
    "SessionContext": {
      "type": "object",
      "properties": {
        "session_id": {
          "type": "string",
          "format": "uuid",
          "description": "Unique session identifier"
        },
        "workflow_step": {
          "type": "integer",
          "minimum": 1,
          "maximum": 10,
          "description": "Current step in the 10-step workflow"
        },
        "workflow_gate": {
          "type": "integer",
          "minimum": 0,
          "maximum": 4,
          "description": "Current workflow gate (0-4)"
        },
        "session_type": {
          "$ref": "#/definitions/SessionType"
        },
        "plan_state": {
          "$ref": "#/definitions/PlanState"
        },
        "created_at": {
          "type": "string",
          "format": "date-time"
        },
        "updated_at": {
          "type": "string",
          "format": "date-time"
        },
        "conversation_history_summary": {
          "type": "string",
          "description": "Summary of prior conversation for context"
        }
      },
      "required": [
        "session_id",
        "workflow_step",
        "workflow_gate",
        "session_type",
        "plan_state",
        "created_at",
        "updated_at"
      ],
      "additionalProperties": false
    },
    "AgentRequest": {
      "type": "object",
      "properties": {
        "request_id": {
          "type": "string",
          "format": "uuid",
          "description": "Unique request identifier"
        },
        "timestamp": {
          "type": "string",
          "format": "date-time",
          "description": "Request timestamp in ISO 8601 format"
        },
        "source_agent": {
          "$ref": "#/definitions/AgentCode",
          "description": "Agent sending the request"
        },
        "target_agent": {
          "$ref": "#/definitions/AgentCode",
          "description": "Agent receiving the request"
        },
        "request_type": {
          "type": "string",
          "minLength": 1,
          "description": "Type of request (agent-specific)"
        },
        "session_context": {
          "$ref": "#/definitions/SessionContext",
          "description": "Current session state"
        },
        "parameters": {
          "type": "object",
          "description": "Request-specific parameters"
        },
        "options": {
          "$ref": "#/definitions/RequestOptions",
          "description": "Request options"
        }
      },
      "required": [
        "request_id",
        "timestamp",
        "source_agent",
        "target_agent",
        "request_type",
        "session_context",
        "parameters"
      ],
      "additionalProperties": false
    },
    "AgentResponseMetadata": {
      "type": "object",
      "properties": {
        "processing_time_ms": {
          "type": "integer",
          "minimum": 0,
          "description": "Processing time in milliseconds"
        },
        "data_sources": {
          "type": "array",
          "items": { "$ref": "#/definitions/DataSource" },
          "description": "Sources used to generate the response"
        },
        "assumptions": {
          "type": "array",
          "items": { "type": "string" },
          "description": "Assumptions made during processing"
        },
        "limitations": {
          "type": "array",
          "items": { "type": "string" },
          "description": "Known limitations of the response"
        },
        "model_version": {
          "type": "string",
          "description": "Version of the model used"
        },
        "kb_documents_used": {
          "type": "array",
          "items": { "type": "string" },
          "description": "KB documents referenced"
        }
      },
      "required": ["processing_time_ms", "data_sources"],
      "additionalProperties": false
    },
    "AgentResponse": {
      "type": "object",
      "properties": {
        "request_id": {
          "type": "string",
          "format": "uuid",
          "description": "ID of the request this responds to"
        },
        "timestamp": {
          "type": "string",
          "format": "date-time",
          "description": "Response timestamp"
        },
        "source_agent": {
          "$ref": "#/definitions/AgentCode",
          "description": "Agent sending the response"
        },
        "status": {
          "type": "string",
          "enum": ["success", "partial", "error"],
          "description": "Response status"
        },
        "data": {
          "type": "object",
          "description": "Response data (agent-specific)"
        },
        "confidence": {
          "$ref": "#/definitions/ConfidenceLevel",
          "description": "Confidence in the response"
        },
        "sources": {
          "type": "array",
          "items": { "$ref": "#/definitions/DataSource" },
          "description": "Data sources used"
        },
        "recommendations": {
          "type": "array",
          "items": { "type": "string" },
          "description": "Optional recommendations"
        },
        "warnings": {
          "type": "array",
          "items": { "type": "string" },
          "description": "Warnings about the response"
        },
        "updated_plan_state": {
          "$ref": "#/definitions/PlanState",
          "description": "Changes to apply to plan state"
        },
        "metadata": {
          "$ref": "#/definitions/AgentResponseMetadata",
          "description": "Response metadata"
        },
        "follow_up_questions": {
          "type": "array",
          "items": { "type": "string" },
          "description": "Suggested follow-up questions"
        }
      },
      "required": [
        "request_id",
        "timestamp",
        "source_agent",
        "status",
        "data",
        "confidence",
        "sources",
        "metadata"
      ],
      "additionalProperties": false
    },
    "AgentErrorCode": {
      "type": "string",
      "enum": [
        "INVALID_REQUEST",
        "MISSING_PARAMETERS",
        "INSUFFICIENT_CONTEXT",
        "CALCULATION_ERROR",
        "KB_RETRIEVAL_ERROR",
        "DATAVERSE_ERROR",
        "DATABRICKS_ERROR",
        "TIMEOUT",
        "AGENT_UNAVAILABLE",
        "CONFIDENCE_TOO_LOW",
        "INTERNAL_ERROR"
      ],
      "description": "Error codes for agent failures"
    },
    "AgentErrorResponse": {
      "type": "object",
      "properties": {
        "request_id": {
          "type": "string",
          "format": "uuid"
        },
        "timestamp": {
          "type": "string",
          "format": "date-time"
        },
        "source_agent": {
          "$ref": "#/definitions/AgentCode"
        },
        "error": {
          "type": "boolean",
          "const": true
        },
        "code": {
          "$ref": "#/definitions/AgentErrorCode"
        },
        "message": {
          "type": "string",
          "description": "Human-readable error message"
        },
        "details": {
          "type": "object",
          "description": "Additional error details"
        },
        "recovery_options": {
          "type": "array",
          "items": { "type": "string" },
          "description": "Suggested recovery actions"
        },
        "fallback_available": {
          "type": "boolean",
          "description": "Whether a fallback response exists"
        },
        "fallback_response": {
          "$ref": "#/definitions/AgentResponse",
          "description": "Fallback response if available"
        }
      },
      "required": [
        "request_id",
        "timestamp",
        "source_agent",
        "error",
        "code",
        "message"
      ],
      "additionalProperties": false
    },
    "ORCRoutingDecision": {
      "type": "object",
      "properties": {
        "target_agent": {
          "$ref": "#/definitions/AgentCode",
          "description": "Agent to route to"
        },
        "request_type": {
          "type": "string",
          "description": "Request type for target agent"
        },
        "confidence": {
          "$ref": "#/definitions/ConfidenceLevel",
          "description": "Routing confidence"
        },
        "routing_rationale": {
          "type": "string",
          "description": "Explanation for routing decision"
        },
        "requires_multi_agent": {
          "type": "boolean",
          "description": "Whether multiple agents needed"
        },
        "agent_sequence": {
          "type": "array",
          "items": { "$ref": "#/definitions/AgentCode" },
          "description": "Sequence of agents to call"
        }
      },
      "required": ["target_agent", "request_type", "confidence"],
      "additionalProperties": false
    }
  },
  "type": "object",
  "oneOf": [
    { "$ref": "#/definitions/AgentRequest" },
    { "$ref": "#/definitions/AgentResponse" },
    { "$ref": "#/definitions/AgentErrorResponse" }
  ]
}
