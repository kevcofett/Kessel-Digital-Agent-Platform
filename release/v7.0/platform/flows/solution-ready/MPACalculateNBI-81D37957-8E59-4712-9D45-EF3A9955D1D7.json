{
  "properties": {
    "connectionReferences": {
      "shared_commondataserviceforapps": {
        "runtimeSource": "embedded",
        "connection": {
          "connectionReferenceLogicalName": "mpa_sharedcommondataserviceforapps_1d3b7"
        },
        "api": {
          "name": "shared_commondataserviceforapps"
        }
      }
    },
    "definition": {
      "$schema": "https://schema.management.azure.com/providers/Microsoft.Logic/schemas/2016-06-01/workflowdefinition.json#",
      "contentVersion": "1.0.0.0",
      "parameters": {
        "$connections": {
          "defaultValue": {},
          "type": "Object"
        },
        "$authentication": {
          "defaultValue": {},
          "type": "SecureObject"
        }
      },
      "triggers": {
        "manual": {
          "metadata": {
            "operationMetadataId": "ed7fb920-643e-4922-8dc4-44fa7ab3cc89"
          },
          "type": "Request",
          "kind": "Http",
          "inputs": {
            "schema": {
              "type": "object",
              "required": [
                "session_id",
                "request_id",
                "current_working_media",
                "projected_working_media",
                "current_performance",
                "projected_performance"
              ],
              "properties": {
                "session_id": {
                  "type": "string",
                  "format": "uuid"
                },
                "request_id": {
                  "type": "string",
                  "format": "uuid"
                },
                "current_working_media": {
                  "type": "number",
                  "minimum": 0,
                  "maximum": 100,
                  "description": "Current working media percentage"
                },
                "projected_working_media": {
                  "type": "number",
                  "minimum": 0,
                  "maximum": 100,
                  "description": "Projected working media percentage after change"
                },
                "current_performance": {
                  "type": "number",
                  "minimum": 0,
                  "description": "Current performance metric value"
                },
                "projected_performance": {
                  "type": "number",
                  "minimum": 0,
                  "description": "Projected performance metric after change"
                },
                "campaign_type": {
                  "type": "string",
                  "enum": [
                    "awareness",
                    "consideration",
                    "conversion"
                  ],
                  "default": "consideration"
                },
                "metric_type": {
                  "type": "string",
                  "enum": [
                    "ctr",
                    "cvr",
                    "cpm",
                    "roas",
                    "viewability"
                  ],
                  "default": "cvr"
                }
              }
            },
            "triggerAuthenticationType": "Tenant"
          }
        }
      },
      "actions": {
        "parse_input": {
          "type": "Compose",
          "inputs": {
            "session_id": "@triggerBody()?['session_id']",
            "request_id": "@triggerBody()?['request_id']",
            "current_working_media": "@triggerBody()?['current_working_media']",
            "projected_working_media": "@triggerBody()?['projected_working_media']",
            "current_performance": "@triggerBody()?['current_performance']",
            "projected_performance": "@triggerBody()?['projected_performance']",
            "campaign_type": "@coalesce(triggerBody()?['campaign_type'], 'consideration')",
            "metric_type": "@coalesce(triggerBody()?['metric_type'], 'cvr')",
            "start_time": "@utcNow()"
          },
          "metadata": {
            "operationMetadataId": "065d875c-f570-4f03-b2f4-6918fd853188"
          },
          "runAfter": {}
        },
        "calculate_fee_savings": {
          "type": "Compose",
          "inputs": {
            "fee_savings": "@sub(outputs('parse_input')?['projected_working_media'], outputs('parse_input')?['current_working_media'])",
            "fee_savings_absolute": "@if(greater(outputs('parse_input')?['projected_working_media'], outputs('parse_input')?['current_working_media']), sub(outputs('parse_input')?['projected_working_media'], outputs('parse_input')?['current_working_media']), 0)"
          },
          "metadata": {
            "operationMetadataId": "36a931e0-d578-48f8-aaf4-28ff0706c00b"
          },
          "runAfter": {
            "parse_input": [
              "Succeeded"
            ]
          }
        },
        "calculate_effectiveness_impact": {
          "type": "Compose",
          "inputs": {
            "performance_delta": "@sub(outputs('parse_input')?['current_performance'], outputs('parse_input')?['projected_performance'])",
            "effectiveness_loss_percent": "@if(equals(outputs('parse_input')?['current_performance'], 0), 0, mul(div(sub(outputs('parse_input')?['current_performance'], outputs('parse_input')?['projected_performance']), outputs('parse_input')?['current_performance']), 100))"
          },
          "metadata": {
            "operationMetadataId": "c97f5641-efd3-42f8-9b81-4afcb02a026d"
          },
          "runAfter": {
            "parse_input": [
              "Succeeded"
            ]
          }
        },
        "determine_weight": {
          "type": "Compose",
          "inputs": {},
          "metadata": {
            "operationMetadataId": "4d9ada1d-f2ce-4190-ad5e-a80225df7c9a"
          },
          "runAfter": {
            "calculate_effectiveness_impact": [
              "Succeeded"
            ]
          }
        },
        "calculate_nbi": {
          "type": "Compose",
          "inputs": {
            "fee_savings": "@outputs('calculate_fee_savings')?['fee_savings']",
            "effectiveness_loss": "@outputs('calculate_effectiveness_impact')?['effectiveness_loss_percent']",
            "weight": "@coalesce(outputs('weight_awareness')?['weight'], outputs('weight_consideration')?['weight'], outputs('weight_conversion')?['weight'], outputs('weight_default')?['weight'])",
            "nbi": "@sub(outputs('calculate_fee_savings')?['fee_savings'], mul(outputs('calculate_effectiveness_impact')?['effectiveness_loss_percent'], coalesce(outputs('weight_awareness')?['weight'], outputs('weight_consideration')?['weight'], outputs('weight_conversion')?['weight'], outputs('weight_default')?['weight'])))"
          },
          "metadata": {
            "operationMetadataId": "a3c3d959-0f61-41e7-890e-0126c6aae591"
          },
          "runAfter": {
            "determine_weight": [
              "Succeeded"
            ]
          }
        },
        "determine_recommendation": {
          "type": "Compose",
          "inputs": {
            "nbi": "@outputs('calculate_nbi')?['nbi']",
            "recommendation": "@if(greater(outputs('calculate_nbi')?['nbi'], 15), 'STRONGLY_RECOMMEND', if(greater(outputs('calculate_nbi')?['nbi'], 8), 'RECOMMEND_WITH_MONITORING', if(greater(outputs('calculate_nbi')?['nbi'], 3), 'EVALUATE_CASE_BY_CASE', if(greater(outputs('calculate_nbi')?['nbi'], -3), 'NEUTRAL', 'NOT_RECOMMENDED'))))",
            "confidence": "@if(greater(outputs('calculate_nbi')?['nbi'], 15), 'HIGH', if(greater(outputs('calculate_nbi')?['nbi'], 8), 'MEDIUM', if(greater(outputs('calculate_nbi')?['nbi'], 3), 'LOW', 'MEDIUM')))",
            "action_guidance": {
              "STRONGLY_RECOMMEND": "Proceed with supply path change. Expected net positive impact.",
              "RECOMMEND_WITH_MONITORING": "Proceed with change. Implement monitoring for 2 weeks.",
              "EVALUATE_CASE_BY_CASE": "Review specific inventory sources before proceeding.",
              "NEUTRAL": "No clear benefit. Consider other optimization priorities.",
              "NOT_RECOMMENDED": "Do not proceed. Effectiveness loss outweighs fee savings."
            }
          },
          "metadata": {
            "operationMetadataId": "f50e7684-2ba0-4731-aa83-c22c50c384c2"
          },
          "runAfter": {
            "calculate_nbi": [
              "Succeeded"
            ]
          }
        },
        "generate_insights": {
          "type": "Compose",
          "inputs": {
            "primary_insight": "@if(greater(outputs('calculate_fee_savings')?['fee_savings'], 0), concat('Supply path change would improve working media by ', string(outputs('calculate_fee_savings')?['fee_savings']), ' percentage points'), 'Supply path change would not improve working media ratio')",
            "trade_off_insight": "@if(greater(outputs('calculate_effectiveness_impact')?['effectiveness_loss_percent'], 0), concat('Expected effectiveness reduction of ', string(outputs('calculate_effectiveness_impact')?['effectiveness_loss_percent']), '% must be weighed against fee savings'), 'No expected effectiveness loss - recommended to proceed')",
            "campaign_context": "@concat('For ', outputs('parse_input')?['campaign_type'], ' campaigns, effectiveness weight is ', string(outputs('calculate_nbi')?['weight']), 'x')"
          },
          "metadata": {
            "operationMetadataId": "97ce78e3-4100-4911-b984-fb636e638b9d"
          },
          "runAfter": {
            "determine_recommendation": [
              "Succeeded"
            ]
          }
        },
        "build_response": {
          "type": "Compose",
          "inputs": {
            "request_id": "@outputs('parse_input')?['request_id']",
            "timestamp": "@utcNow()",
            "source_agent": "SPO",
            "status": "success",
            "data": {
              "nbi": "@outputs('calculate_nbi')?['nbi']",
              "fee_savings_pct": "@outputs('calculate_fee_savings')?['fee_savings']",
              "effectiveness_loss_pct": "@outputs('calculate_effectiveness_impact')?['effectiveness_loss_percent']",
              "campaign_weight": "@outputs('calculate_nbi')?['weight']",
              "recommendation": "@outputs('determine_recommendation')?['recommendation']",
              "confidence": "@outputs('determine_recommendation')?['confidence']",
              "action_guidance": "@outputs('determine_recommendation')?['action_guidance']?[outputs('determine_recommendation')?['recommendation']]",
              "inputs_summary": {
                "current_working_media": "@outputs('parse_input')?['current_working_media']",
                "projected_working_media": "@outputs('parse_input')?['projected_working_media']",
                "current_performance": "@outputs('parse_input')?['current_performance']",
                "projected_performance": "@outputs('parse_input')?['projected_performance']",
                "campaign_type": "@outputs('parse_input')?['campaign_type']"
              },
              "insights": "@outputs('generate_insights')"
            },
            "confidence": "@outputs('determine_recommendation')?['confidence']",
            "sources": [
              "CALCULATION",
              "AGENT_KB"
            ],
            "recommendations": [
              "@outputs('determine_recommendation')?['action_guidance']?[outputs('determine_recommendation')?['recommendation']]",
              "Monitor quality metrics for 2 weeks post-implementation",
              "Document baseline metrics before making changes"
            ],
            "metadata": {
              "processing_time_ms": "@div(sub(ticks(utcNow()), ticks(outputs('parse_input')?['start_time'])), 10000)",
              "nbi_formula": "NBI = Fee Savings - (Effectiveness Loss \u00d7 Campaign Weight)"
            }
          },
          "metadata": {
            "operationMetadataId": "35de0ac8-d18c-4e5c-acc7-b914e69fcb51"
          },
          "runAfter": {
            "generate_insights": [
              "Succeeded"
            ]
          }
        },
        "return_response": {
          "type": "Response",
          "kind": "Http",
          "inputs": {
            "statusCode": 200,
            "body": "@outputs('build_response')",
            "headers": {
              "Content-Type": "application/json"
            }
          },
          "metadata": {
            "operationMetadataId": "8082d19a-ce82-4d80-a3d4-653b346d613c"
          },
          "runAfter": {}
        }
      }
    },
    "templateName": null
  },
  "schemaVersion": "1.0.0.0"
}