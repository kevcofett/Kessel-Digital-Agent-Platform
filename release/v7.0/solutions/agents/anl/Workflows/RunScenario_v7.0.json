{
  "schemaVersion": "1.0.0.0",
  "properties": {
    "connectionReferences": {
      "shared_commondataserviceforapps": {
        "connectionName": "shared-commondataserviceforapps",
        "source": "Invoker",
        "id": "/providers/Microsoft.PowerApps/apis/shared_commondataserviceforapps",
        "tier": "NotSpecified"
      }
    },
    "definition": {
      "$schema": "https://schema.management.azure.com/providers/Microsoft.Logic/schemas/2016-06-01/workflowdefinition.json#",
      "contentVersion": "1.0.0.0",
      "parameters": {
        "$connections": {
          "defaultValue": {},
          "type": "Object"
        },
        "$authentication": {
          "defaultValue": {},
          "type": "SecureObject"
        }
      },
      "triggers": {
        "manual": {
          "type": "Request",
          "kind": "Http",
          "inputs": {
            "schema": {
              "type": "object",
              "required": ["session_id", "request_id", "scenario_type"],
              "properties": {
                "session_id": {
                  "type": "string",
                  "format": "uuid"
                },
                "request_id": {
                  "type": "string",
                  "format": "uuid"
                },
                "scenario_type": {
                  "type": "string",
                  "enum": ["budget_change", "channel_shift", "objective_change", "timing_change"]
                },
                "base_plan": {
                  "type": "object"
                },
                "scenario_parameters": {
                  "type": "object"
                },
                "comparison_metrics": {
                  "type": "array",
                  "items": { "type": "string" }
                }
              }
            },
            "method": "POST"
          },
          "operationOptions": "EnableSchemaValidation"
        }
      },
      "actions": {
        "Parse_Input": {
          "type": "Compose",
          "inputs": {
            "session_id": "@triggerBody()?['session_id']",
            "request_id": "@triggerBody()?['request_id']",
            "scenario_type": "@triggerBody()?['scenario_type']",
            "base_plan": "@coalesce(triggerBody()?['base_plan'], json('{\"budget\": 500000, \"channel_mix\": {\"meta_facebook\": 30, \"google_search\": 25, \"youtube\": 20, \"programmatic_display\": 15, \"tiktok\": 10}}'))",
            "scenario_parameters": "@triggerBody()?['scenario_parameters']",
            "comparison_metrics": "@coalesce(triggerBody()?['comparison_metrics'], createArray('impressions', 'reach', 'conversions', 'roas', 'cpa'))",
            "start_time": "@utcNow()"
          },
          "runAfter": {}
        },
        "Load_Scenario_Templates": {
          "type": "Compose",
          "inputs": {
            "scenario_templates": {
              "budget_change": {
                "variations": [
                  { "name": "Budget +20%", "multiplier": 1.20 },
                  { "name": "Budget +10%", "multiplier": 1.10 },
                  { "name": "Budget -10%", "multiplier": 0.90 },
                  { "name": "Budget -20%", "multiplier": 0.80 }
                ],
                "impact_factors": {
                  "diminishing_returns_coefficient": 0.85,
                  "efficiency_decay_start": 1.25
                }
              },
              "channel_shift": {
                "variations": [
                  { "name": "Search Heavy", "shift": { "google_search": 15, "meta_facebook": -10, "youtube": -5 } },
                  { "name": "Social Heavy", "shift": { "meta_facebook": 10, "tiktok": 10, "google_search": -15, "programmatic_display": -5 } },
                  { "name": "Video Focus", "shift": { "youtube": 15, "meta_facebook": -5, "google_search": -5, "programmatic_display": -5 } }
                ]
              },
              "objective_change": {
                "variations": [
                  { "name": "Awareness Focus", "objective": "awareness" },
                  { "name": "Conversion Focus", "objective": "conversion" },
                  { "name": "Balanced Approach", "objective": "consideration" }
                ]
              },
              "timing_change": {
                "variations": [
                  { "name": "Accelerated (8 weeks)", "weeks": 8 },
                  { "name": "Standard (12 weeks)", "weeks": 12 },
                  { "name": "Extended (16 weeks)", "weeks": 16 }
                ]
              }
            }
          },
          "runAfter": {
            "Parse_Input": ["Succeeded"]
          }
        },
        "Calculate_Base_Projections": {
          "type": "Compose",
          "inputs": {
            "base_metrics": {
              "impressions": "@mul(div(outputs('Parse_Input')?['base_plan']?['budget'], 8), 1000)",
              "reach": "@mul(div(outputs('Parse_Input')?['base_plan']?['budget'], 8), 300)",
              "clicks": "@mul(div(outputs('Parse_Input')?['base_plan']?['budget'], 8), 12)",
              "conversions": "@mul(div(outputs('Parse_Input')?['base_plan']?['budget'], 8), 0.5)",
              "cpm": 8.00,
              "cpc": 2.50,
              "cpa": 75.00,
              "roas": 2.20
            },
            "base_budget": "@outputs('Parse_Input')?['base_plan']?['budget']"
          },
          "runAfter": {
            "Load_Scenario_Templates": ["Succeeded"]
          }
        },
        "Run_Scenario_Variations": {
          "type": "Compose",
          "inputs": {
            "scenario_type": "@outputs('Parse_Input')?['scenario_type']",
            "variations_calculated": {
              "variation_1": {
                "name": "Variation A",
                "projected_impressions": "@mul(outputs('Calculate_Base_Projections')?['base_metrics']?['impressions'], 1.15)",
                "projected_reach": "@mul(outputs('Calculate_Base_Projections')?['base_metrics']?['reach'], 1.12)",
                "projected_conversions": "@mul(outputs('Calculate_Base_Projections')?['base_metrics']?['conversions'], 1.08)",
                "projected_roas": "@mul(outputs('Calculate_Base_Projections')?['base_metrics']?['roas'], 0.95)",
                "projected_cpa": "@mul(outputs('Calculate_Base_Projections')?['base_metrics']?['cpa'], 1.05)"
              },
              "variation_2": {
                "name": "Variation B",
                "projected_impressions": "@mul(outputs('Calculate_Base_Projections')?['base_metrics']?['impressions'], 1.08)",
                "projected_reach": "@mul(outputs('Calculate_Base_Projections')?['base_metrics']?['reach'], 1.06)",
                "projected_conversions": "@mul(outputs('Calculate_Base_Projections')?['base_metrics']?['conversions'], 1.04)",
                "projected_roas": "@mul(outputs('Calculate_Base_Projections')?['base_metrics']?['roas'], 0.98)",
                "projected_cpa": "@mul(outputs('Calculate_Base_Projections')?['base_metrics']?['cpa'], 1.02)"
              },
              "variation_3": {
                "name": "Variation C",
                "projected_impressions": "@mul(outputs('Calculate_Base_Projections')?['base_metrics']?['impressions'], 0.92)",
                "projected_reach": "@mul(outputs('Calculate_Base_Projections')?['base_metrics']?['reach'], 0.94)",
                "projected_conversions": "@mul(outputs('Calculate_Base_Projections')?['base_metrics']?['conversions'], 0.96)",
                "projected_roas": "@mul(outputs('Calculate_Base_Projections')?['base_metrics']?['roas'], 1.02)",
                "projected_cpa": "@mul(outputs('Calculate_Base_Projections')?['base_metrics']?['cpa'], 0.98)"
              }
            }
          },
          "runAfter": {
            "Calculate_Base_Projections": ["Succeeded"]
          }
        },
        "Compare_Scenarios": {
          "type": "Compose",
          "inputs": {
            "comparison_summary": {
              "base_plan": "@outputs('Calculate_Base_Projections')?['base_metrics']",
              "best_for_reach": "variation_1",
              "best_for_conversions": "variation_1",
              "best_for_efficiency": "variation_3",
              "recommended_scenario": "variation_2",
              "recommendation_rationale": "Balanced approach with moderate gains and acceptable efficiency trade-off"
            },
            "trade_off_analysis": {
              "reach_vs_efficiency": "Higher budget scenarios increase reach but reduce efficiency",
              "conversions_vs_cpa": "More conversions achievable but at higher cost per acquisition",
              "risk_assessment": "Moderate risk with recommended scenario"
            }
          },
          "runAfter": {
            "Run_Scenario_Variations": ["Succeeded"]
          }
        },
        "Build_Response": {
          "type": "Compose",
          "inputs": {
            "request_id": "@outputs('Parse_Input')?['request_id']",
            "timestamp": "@utcNow()",
            "source_agent": "ANL",
            "status": "success",
            "data": {
              "scenario_analysis": {
                "scenario_type": "@outputs('Parse_Input')?['scenario_type']",
                "base_plan": "@outputs('Parse_Input')?['base_plan']",
                "variations_count": 3
              },
              "base_projections": "@outputs('Calculate_Base_Projections')?['base_metrics']",
              "scenario_variations": "@outputs('Run_Scenario_Variations')?['variations_calculated']",
              "comparison": "@outputs('Compare_Scenarios')?['comparison_summary']",
              "trade_offs": "@outputs('Compare_Scenarios')?['trade_off_analysis']"
            },
            "confidence": "MEDIUM",
            "sources": ["CALCULATION", "SCENARIO_MODEL", "AGENT_KB"],
            "recommendations": [
              "Consider recommended scenario for balanced performance",
              "Run sensitivity analysis for key assumptions",
              "Monitor early indicators to validate projections"
            ],
            "metadata": {
              "processing_time_ms": "@div(sub(ticks(utcNow()), ticks(outputs('Parse_Input')?['start_time'])), 10000)",
              "scenarios_evaluated": 3
            }
          },
          "runAfter": {
            "Compare_Scenarios": ["Succeeded"]
          }
        },
        "Response": {
          "type": "Response",
          "kind": "Http",
          "inputs": {
            "statusCode": 200,
            "headers": {
              "Content-Type": "application/json"
            },
            "body": "@outputs('Build_Response')"
          },
          "runAfter": {
            "Build_Response": ["Succeeded"]
          }
        }
      }
    }
  }
}
