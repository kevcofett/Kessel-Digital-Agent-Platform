{
  "schemaVersion": "1.0.0.0",
  "properties": {
    "connectionReferences": {
      "shared_commondataserviceforapps": {
        "connectionName": "shared-commondataserviceforapps",
        "source": "Invoker",
        "id": "/providers/Microsoft.PowerApps/apis/shared_commondataserviceforapps",
        "tier": "NotSpecified"
      }
    },
    "definition": {
      "$schema": "https://schema.management.azure.com/providers/Microsoft.Logic/schemas/2016-06-01/workflowdefinition.json#",
      "contentVersion": "1.0.0.0",
      "parameters": {
        "$connections": {
          "defaultValue": {},
          "type": "Object"
        },
        "$authentication": {
          "defaultValue": {},
          "type": "SecureObject"
        }
      },
      "triggers": {
        "manual": {
          "type": "Request",
          "kind": "Http",
          "inputs": {
            "schema": {
              "type": "object",
              "required": ["session_id", "request_id"],
              "properties": {
                "session_id": {
                  "type": "string",
                  "format": "uuid"
                },
                "request_id": {
                  "type": "string",
                  "format": "uuid"
                },
                "document_type": {
                  "type": "string",
                  "enum": ["media_plan", "performance_report", "proposal", "presentation", "executive_summary"]
                },
                "document_data": {
                  "type": "object"
                },
                "format": {
                  "type": "string",
                  "enum": ["pdf", "docx", "pptx", "html"]
                },
                "template_id": {
                  "type": "string"
                }
              }
            },
            "method": "POST"
          },
          "operationOptions": "EnableSchemaValidation"
        }
      },
      "actions": {
        "Parse_Input": {
          "type": "Compose",
          "inputs": {
            "session_id": "@triggerBody()?['session_id']",
            "request_id": "@triggerBody()?['request_id']",
            "document_type": "@coalesce(triggerBody()?['document_type'], 'media_plan')",
            "document_data": "@coalesce(triggerBody()?['document_data'], json('{}'))",
            "format": "@coalesce(triggerBody()?['format'], 'pdf')",
            "template_id": "@coalesce(triggerBody()?['template_id'], 'default')",
            "start_time": "@utcNow()"
          },
          "runAfter": {}
        },
        "Load_Document_Templates": {
          "type": "Compose",
          "inputs": {
            "templates": {
              "media_plan": {
                "name": "Media Plan Document",
                "sections": [
                  { "id": "cover", "name": "Cover Page", "required": true },
                  { "id": "executive_summary", "name": "Executive Summary", "required": true },
                  { "id": "objectives", "name": "Campaign Objectives", "required": true },
                  { "id": "audience", "name": "Target Audience", "required": true },
                  { "id": "strategy", "name": "Media Strategy", "required": true },
                  { "id": "channel_mix", "name": "Channel Mix", "required": true },
                  { "id": "budget", "name": "Budget Allocation", "required": true },
                  { "id": "timeline", "name": "Campaign Timeline", "required": true },
                  { "id": "measurement", "name": "Measurement Framework", "required": true },
                  { "id": "appendix", "name": "Appendix", "required": false }
                ],
                "style": { "theme": "professional", "color_scheme": "brand" }
              },
              "performance_report": {
                "name": "Performance Report",
                "sections": [
                  { "id": "cover", "name": "Cover Page", "required": true },
                  { "id": "executive_summary", "name": "Executive Summary", "required": true },
                  { "id": "kpi_dashboard", "name": "KPI Dashboard", "required": true },
                  { "id": "channel_performance", "name": "Channel Performance", "required": true },
                  { "id": "insights", "name": "Key Insights", "required": true },
                  { "id": "optimizations", "name": "Optimization Actions", "required": true },
                  { "id": "recommendations", "name": "Recommendations", "required": true },
                  { "id": "next_steps", "name": "Next Steps", "required": true }
                ],
                "style": { "theme": "data_focused", "color_scheme": "analytics" }
              },
              "proposal": {
                "name": "Media Proposal",
                "sections": [
                  { "id": "cover", "name": "Cover Page", "required": true },
                  { "id": "about_us", "name": "About Us", "required": true },
                  { "id": "understanding", "name": "Our Understanding", "required": true },
                  { "id": "approach", "name": "Proposed Approach", "required": true },
                  { "id": "solution", "name": "Solution Overview", "required": true },
                  { "id": "team", "name": "Team", "required": false },
                  { "id": "investment", "name": "Investment", "required": true },
                  { "id": "case_studies", "name": "Case Studies", "required": false },
                  { "id": "next_steps", "name": "Next Steps", "required": true }
                ],
                "style": { "theme": "persuasive", "color_scheme": "brand" }
              },
              "executive_summary": {
                "name": "Executive Summary",
                "sections": [
                  { "id": "header", "name": "Header", "required": true },
                  { "id": "situation", "name": "Situation Overview", "required": true },
                  { "id": "key_findings", "name": "Key Findings", "required": true },
                  { "id": "recommendations", "name": "Recommendations", "required": true },
                  { "id": "next_steps", "name": "Next Steps", "required": true }
                ],
                "style": { "theme": "concise", "color_scheme": "professional" }
              }
            }
          },
          "runAfter": {
            "Parse_Input": ["Succeeded"]
          }
        },
        "Generate_Document_Structure": {
          "type": "Compose",
          "inputs": {
            "document_structure": {
              "metadata": {
                "document_id": "@guid()",
                "created_date": "@utcNow('yyyy-MM-dd')",
                "created_by": "MPA Document Agent",
                "version": "1.0",
                "status": "draft"
              },
              "cover_page": {
                "title": "Media Plan - Q1 2024",
                "subtitle": "Comprehensive Media Strategy",
                "client": "Client Name",
                "prepared_by": "Media Planning Team",
                "date": "@utcNow('MMMM dd, yyyy')"
              },
              "table_of_contents": {
                "generated": true,
                "page_numbers": true
              },
              "content_sections": [
                {
                  "section_id": "executive_summary",
                  "title": "Executive Summary",
                  "content_type": "text",
                  "page_break_before": false
                },
                {
                  "section_id": "objectives",
                  "title": "Campaign Objectives",
                  "content_type": "mixed",
                  "page_break_before": true
                },
                {
                  "section_id": "audience",
                  "title": "Target Audience",
                  "content_type": "mixed",
                  "page_break_before": true
                },
                {
                  "section_id": "strategy",
                  "title": "Media Strategy",
                  "content_type": "mixed",
                  "page_break_before": true
                },
                {
                  "section_id": "channel_mix",
                  "title": "Channel Mix & Allocation",
                  "content_type": "charts",
                  "page_break_before": true
                },
                {
                  "section_id": "budget",
                  "title": "Budget Allocation",
                  "content_type": "tables",
                  "page_break_before": true
                },
                {
                  "section_id": "timeline",
                  "title": "Campaign Timeline",
                  "content_type": "gantt",
                  "page_break_before": true
                },
                {
                  "section_id": "measurement",
                  "title": "Measurement Framework",
                  "content_type": "mixed",
                  "page_break_before": true
                }
              ],
              "styling": {
                "font_family": "Arial",
                "heading_font": "Arial Bold",
                "primary_color": "#1E3A5F",
                "secondary_color": "#4A90D9",
                "accent_color": "#F5A623"
              }
            }
          },
          "runAfter": {
            "Load_Document_Templates": ["Succeeded"]
          }
        },
        "Populate_Document_Content": {
          "type": "Compose",
          "inputs": {
            "populated_content": {
              "executive_summary": {
                "overview": "This media plan outlines a comprehensive strategy to achieve brand awareness and lead generation objectives for Q1 2024.",
                "key_highlights": [
                  "Total investment: $1.5M across 5 channels",
                  "Projected reach: 5M unique users",
                  "Campaign duration: 12 weeks",
                  "Primary focus: Digital channels with 85% of budget"
                ],
                "expected_outcomes": [
                  "10% increase in brand awareness",
                  "5,000 marketing qualified leads",
                  "4:1 target ROAS"
                ]
              },
              "objectives": {
                "business_objectives": [
                  "Increase market share by 3%",
                  "Drive revenue growth of 15%"
                ],
                "marketing_objectives": [
                  "Build brand awareness among target audience",
                  "Generate qualified leads for sales pipeline"
                ],
                "media_objectives": [
                  "Achieve 5M reach with 3+ frequency",
                  "Drive 100K website visits",
                  "Generate 5K lead form submissions"
                ]
              },
              "channel_allocation": {
                "programmatic_display": { "budget": 450000, "percentage": 30, "impressions": "15M" },
                "paid_social": { "budget": 375000, "percentage": 25, "impressions": "12M" },
                "paid_search": { "budget": 300000, "percentage": 20, "clicks": "150K" },
                "video_ctv": { "budget": 225000, "percentage": 15, "views": "2M" },
                "native": { "budget": 150000, "percentage": 10, "impressions": "5M" }
              },
              "timeline": {
                "phases": [
                  { "phase": "Planning & Setup", "start": "Week -2", "end": "Week 0" },
                  { "phase": "Awareness Phase", "start": "Week 1", "end": "Week 4" },
                  { "phase": "Consideration Phase", "start": "Week 5", "end": "Week 8" },
                  { "phase": "Conversion Phase", "start": "Week 9", "end": "Week 12" }
                ]
              }
            }
          },
          "runAfter": {
            "Generate_Document_Structure": ["Succeeded"]
          }
        },
        "Generate_Output_Metadata": {
          "type": "Compose",
          "inputs": {
            "output_metadata": {
              "file_name": "Media_Plan_Q1_2024.pdf",
              "format": "@outputs('Parse_Input')?['format']",
              "page_count": 24,
              "file_size_estimate": "2.4 MB",
              "generation_status": "ready",
              "download_url": "/documents/@{guid()}/download",
              "preview_url": "/documents/@{guid()}/preview"
            }
          },
          "runAfter": {
            "Populate_Document_Content": ["Succeeded"]
          }
        },
        "Build_Response": {
          "type": "Compose",
          "inputs": {
            "request_id": "@outputs('Parse_Input')?['request_id']",
            "timestamp": "@utcNow()",
            "source_agent": "DOC",
            "status": "success",
            "data": {
              "document_summary": {
                "document_type": "@outputs('Parse_Input')?['document_type']",
                "format": "@outputs('Parse_Input')?['format']",
                "template_id": "@outputs('Parse_Input')?['template_id']"
              },
              "document_structure": "@outputs('Generate_Document_Structure')?['document_structure']",
              "document_content": "@outputs('Populate_Document_Content')?['populated_content']",
              "output_metadata": "@outputs('Generate_Output_Metadata')?['output_metadata']"
            },
            "confidence": "HIGH",
            "sources": ["DOCUMENT_TEMPLATES", "STYLE_GUIDE", "AGENT_KB"],
            "recommendations": [
              "Review document for accuracy before distribution",
              "Consider adding appendix with detailed data",
              "Update version number when finalized"
            ],
            "metadata": {
              "processing_time_ms": "@div(sub(ticks(utcNow()), ticks(outputs('Parse_Input')?['start_time'])), 10000)"
            }
          },
          "runAfter": {
            "Generate_Output_Metadata": ["Succeeded"]
          }
        },
        "Response": {
          "type": "Response",
          "kind": "Http",
          "inputs": {
            "statusCode": 200,
            "headers": {
              "Content-Type": "application/json"
            },
            "body": "@outputs('Build_Response')"
          },
          "runAfter": {
            "Build_Response": ["Succeeded"]
          }
        }
      }
    }
  }
}
